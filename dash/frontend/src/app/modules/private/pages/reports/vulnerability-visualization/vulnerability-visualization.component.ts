import {AfterViewInit, Component, HostListener, OnDestroy, OnInit} from '@angular/core';
import {take, takeUntil} from 'rxjs/operators';
import {ActivatedRoute} from '@angular/router';
import {FormBuilder, FormGroup} from '@angular/forms';
import {NamespaceService} from '../../../../../core/services/namespace.service';
import {ImageService} from '../../../../../core/services/image.service';
import {differenceInCalendarDays, format, isAfter, isPast, sub, set} from 'date-fns';
import {AlertService} from '@full-fledged/alerts';
import {Subject} from 'rxjs';
import {VulnerabilitySeverity} from '../../../../../core/enum/VulnerabilitySeverity';
import {ChartSizeService} from '../../../../../core/services/chart-size.service';

@Component({
  selector: 'app-vulnerability-visualization',
  templateUrl: './vulnerability-visualization.component.html',
  styleUrls: ['./vulnerability-visualization.component.scss']
})
export class VulnerabilityVisualizationComponent implements OnInit, AfterViewInit, OnDestroy {
  private unsubscribe$ = new Subject<void>();
  clusterId: number;
  filterForm: FormGroup;
  clusterNamespaces: Array<string>;
  barChartAttributes = {
    view: [],
    colorScheme: {
      domain: ['#ec3c3c', '#f3865f', '#596fe0', '#59e059', '#888888']
    },
    results: [],
    gradient: false,
    showXAxis: true,
    showYAxis: true,
    barPadding: 2,
    showLegend: false,
    legendPosition: 'below',
    showXAxisLabel: true,
    showYAxisLabel: true,
    yAxisLabel: 'Vulnerabilities',
    xAxisLabel: 'Day of Month',
  };
  startDate: string;
  endDate: string;
  namespaces: Array<string>;
  resizeTimeout;

  constructor(
    private route: ActivatedRoute,
    private formBuilder: FormBuilder,
    private namespaceService: NamespaceService,
    private imageService: ImageService,
    private alertService: AlertService,
    private chartSizeService: ChartSizeService,
  ) {}

  ngOnInit() {
    this.route.parent.parent.params
      .pipe(take(1))
      .subscribe(param => this.clusterId = param.id);

    this.namespaceService.getAllK8sNamespaces(this.clusterId)
      .pipe(take(1))
      .subscribe((response) => {
        this.clusterNamespaces = new Array<string>();
        for (const namespace of response.data) {
          this.clusterNamespaces.push(namespace.name);
        }
        this.clusterNamespaces.sort();
      });

    const currentDate = set(new Date(), {hours: 0, minutes: 0, seconds: 0, milliseconds: 0});

    this.filterForm = this.formBuilder.group({
      namespaces: [[]],
      startDate: [sub(currentDate, {days: 28})],
      endDate: [currentDate]
    });

    this.endDate = format(currentDate, 'yyyy-MM-dd');
    this.startDate = format(sub(currentDate, {days: 28}), 'yyyy-MM-dd');
    this.namespaces = new Array<string>();

    this.buildBarChartData();
  }

  ngAfterViewInit() {
    this.setChartSize();
  }

  buildBarChartData() {
    const filters = {clusterIds: [this.clusterId],
      startDate: this.startDate,
      endDate: this.endDate,
      namespace: this.namespaces
    };
    this.imageService.getCountOfVulnerabilities(filters, 'savedAtDate')
      .pipe(take(1))
      .subscribe(response => {
        this.barChartAttributes.results = response.data && response.data.length > 0 ? response.data.map(data => {
          return {
            name: data.savedAtDate.split('T')[0],
            series: [
              {
                name: VulnerabilitySeverity.CRITICAL,
                value: +data.criticalIssues
              },
              {
                name: VulnerabilitySeverity.MAJOR,
                value: +data.majorIssues
              },
              {
                name: VulnerabilitySeverity.MEDIUM,
                value: +data.mediumIssues
              },
              {
                name: VulnerabilitySeverity.LOW,
                value: +data.lowIssues
              },
              {
                name: VulnerabilitySeverity.NEGLIGIBLE,
                value: +data.negligibleIssues
              },
            ]
          };
        }) : [];
      },
        error => {
        this.alertService.danger(error.error.message);
        });
  }

  rebuildWithFilters() {
    if (differenceInCalendarDays(this.filterForm.get('endDate')?.value, this.filterForm.get('startDate')?.value) > 365) {
      this.alertService.danger('Please select a date range under 365 days');
    } else {
      this.startDate = format(this.filterForm.get('startDate').value, 'yyyy-MM-dd');
      this.endDate = format(this.filterForm.get('endDate').value, 'yyyy-MM-dd');
      this.namespaces = this.filterForm.get('namespaces')?.value;

      this.buildBarChartData();
    }
  }


  get filtersValid(): boolean {
    return this.filterForm.valid &&
      !isAfter(this.filterForm.get('startDate')?.value, this.filterForm.get('endDate')?.value) &&
      isPast(this.filterForm.get('startDate')?.value) && isPast(this.filterForm.get('endDate')?.value);
  }

  scanXTickFormatting = (e: string) => {
    return e.split('-')[2];
  }

  @HostListener('window:resize', ['$event'])
  setScreenSize($event?: any) {
    this.setChartSize();
  }

  setChartSize(isInitial = false) {
    // debounce chart resizing
    clearTimeout(this.resizeTimeout);
    this.resizeTimeout = setTimeout(() => {
      this.executeResize(isInitial);
    }, 100);
  }

  executeResize(isInitial = false) {
    const innerWindow = document.getElementsByTagName('app-vulnerability-visualization').item(0) as HTMLElement;
    let innerScreenWidth = innerWindow.offsetWidth;
    if (isInitial) {
      const sideNav = document.getElementById('primary-side-nav');
      if (sideNav.style.visibility !== 'hidden') {
        // have to do this the first time b/c the side nav is not yet in place
        // --> the width retrieved doesn't take it into account
        innerScreenWidth -= sideNav.clientWidth;
      }
    }
    this.barChartAttributes.view = this.chartSizeService.getChartSize(
      innerScreenWidth,
      { xs: 1, s: 1, m: 1, l: 1 },
      { left: 20, right: 20 },
      { left: 0, right: 0 },
      { left: 0, right: 0 },
      { left: 16, right: 16 },
      600,
    );
  }

  ngOnDestroy() {
    this.unsubscribe$.next();
    this.unsubscribe$.complete();
  }
}
