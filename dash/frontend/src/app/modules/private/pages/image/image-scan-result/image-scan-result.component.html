<div class="page-container">
  <div class="page-container-content">
    <mat-card id="scanInformation" class="mb-xs-3 pt-xs-3" *ngIf="dataSource">
      <div class="row header-row m-xs-0">
        <div class="col-lg-9 col-xs-12">
          <span id="image-name" [matTooltip]="dataSource.url + '/' + dataSource.name + ':' + dataSource.tag" >Image: {{dataSource.name+':'+dataSource.tag}}</span>
        </div>
        <div class="col-lg-2 col-lg-offset-1 justify-content-lg-end col-xs-12 justify-content-xs-start">
          <div class="me-lg-3 me-xs-0">
            <mat-spinner *ngIf="displayImageScanSpinner$ | async" [diameter]="30"></mat-spinner>
          </div>
          <button type="button" color="primary" mat-raised-button
             class=""
             *ngIf="dataSource || !dataSource"
             [disabled]="displayImageScanSpinner$ | async"
             (click)="scanImage()">{{ scanButtonText }}</button>
        </div>
      </div>
      <div class="row header-row m-xs-0">
        <div class="col-xs-12">
          <span [matTooltip]="dataSource.dockerImageId"
                matTooltipClass="image-id-tooltip"
                style="overflow:hidden; text-overflow:ellipsis"
          >Image ID: {{dataSource.dockerImageId}}</span>

          <span style="display: none" [matTooltip]="dataSource.dockerImageId"
                matTooltipClass="image-id-tooltip"
          >Image ID: {{dataSource.dockerImageId.length > 15 ?
            dataSource.dockerImageId.substring(0, 15) + '...' : dataSource.dockerImageId}}</span>
        </div>
      </div>
      <div class="image-details">
        <div class="left-elements">
          <div class="elements" style="min-width: 110px;">
            <p>Scan Result</p>
            <p class="first-element-content" [ngStyle]="{'color': scanResultTextColor}">{{scanResultText}}</p>
          </div>
          <div class="elements" style="min-width: 160px;">
            <p>Last Scanned</p>
            <div *ngIf="dataSource.lastScanned; else elseBlock">
              <p>{{dataSource.lastScanned | date: 'MM/dd/yyyy hh:mma'}}</p>
            </div>
            <ng-template #elseBlock>
              <p>Not Scanned</p>
            </ng-template>
          </div>
          <div class="elements">
            <p>Running</p>
            <p >{{dataSource.runningInCluster}}</p>
          </div>
        </div>
        <div class="right-elements" >
          <div class="elements">
            <p>Critical</p>
            <p>{{dataSource.criticalIssues}}</p>
          </div>
          <div class="elements">
            <p>Major</p>
            <p >{{dataSource.majorIssues}}</p>
          </div>
          <div class="elements">
            <p>Medium</p>
            <p >{{dataSource.mediumIssues}}</p>
          </div>
          <div class="elements">
            <p>Low</p>
            <p >{{dataSource.lowIssues}}</p>
          </div>
          <div class="elements">
            <p>Negligible</p>
            <p >{{dataSource.negligibleIssues}}</p>
          </div>
        </div>
      </div>
    </mat-card>
    <mat-card id="scannerError" class="mb-xs-3 pt-xs-3" *ngIf="lastScanReport?.encounterError">
      <h3 class="error-msg" style="margin: unset; padding: 5px 10px;">Error</h3>
      <div [innerHTML]="lastScanReport?.summary" class="error-msg"></div>
    </mat-card>
    <mat-card id="scannerComplianceList" class="mb-xs-3 pt-xs-3 pb-xs-4 scrollable-table-card" *ngIf="displayComplianceAndIssueTable">
      <div class="row header-row m-xs-0">
        <div class="col-xs-12 col-sm-9 col-lg-10" id="compliance-report-title">
          <span matTooltip="Scanner Compliance Report">Scanner Compliance Report</span>
        </div>
        <div class="col-xs-10 col-sm-3 col-lg-2 advanced-search" id="compliance-report-buttons" *ngIf="imageScanDates">
          <mat-select class="p-xs-2 title=font" [formControl]="scanDateDefault" (selectionChange)="onChangeScanDate($event)">
            <mat-option *ngFor="let scanDate of imageScanDates" [value]="scanDate.created_at"> {{scanDate.created_at | date: 'MM/dd/yyyy hh:mma'}}</mat-option>
          </mat-select>
        </div>
      </div>
      <div class="table-wrapper">
        <mat-table [dataSource]="scannerComplianceReport" #complianceSort="matSort" matSort  matSortActive="policy" matSortDisableClear matSortDirection="asc">
          <ng-container matColumnDef="policy">
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear matTooltip="Policy">Policy</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.policyName}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear matTooltip="Passed/Failed">Passed/Failed</mat-header-cell>
            <mat-cell *matCellDef="let result">  {{result.policyStatus ? 'Passed' : 'Failed' }} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="compliant">
            <mat-header-cell *matHeaderCellDef matTooltip="Compliant">Compliant</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.policyStatus ? 'Yes' : 'No'}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="required">
            <mat-header-cell *matHeaderCellDef matTooltip="Required">Required</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.policyRequirement ? 'Yes' : 'No' }} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="critical_issues">
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear [matTooltip]="CVETypes.CRITICAL |titlecase">{{CVETypeAbbreviations.CRITICAL |titlecase }}</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.criticalIssues}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="major_issues">
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear [matTooltip]="CVETypes.MAJOR |titlecase">{{CVETypeAbbreviations.MAJOR |titlecase }}</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.majorIssues}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="medium_issues" >
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear [matTooltip]="CVETypes.MEDIUM |titlecase">{{CVETypeAbbreviations.MEDIUM |titlecase }}</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.mediumIssues}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="low_issues">
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear [matTooltip]="CVETypes.LOW |titlecase">{{CVETypeAbbreviations.LOW |titlecase }}</mat-header-cell>
            <mat-cell *matCellDef="let result" > {{result.lowIssues}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="negligible_issues">
            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear [matTooltip]="CVETypes.NEGLIGIBLE |titlecase">{{CVETypeAbbreviations.NEGLIGIBLE |titlecase }}</mat-header-cell>
            <mat-cell *matCellDef="let result"> {{result.negligibleIssues}} </mat-cell>
          </ng-container>
          <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;" (click)="getIssuesByPolicy(row)" class="table-row"></mat-row>
        </mat-table>
      </div>
      <mat-paginator
        [length]="totalCount"
        [pageSize]="limit"
        [pageSizeOptions]="[10, 20, 50, 100, 200, 500, 1000]"
        (page)="scannerPageEvent($event)"
        showFirstLastButtons #compliancePaginator></mat-paginator>
    </mat-card>
    <mat-card id="issuesList" class="mb-xs-3 pt-xs-3 pb-xs-4 scrollable-table-card" *ngIf="displayComplianceAndIssueTable">
      <div class="row header-row m-xs-0">
        <div class="col-xs-9 col-sm-3" id="issuesTitle">
          Issues
        </div>
        <div class="col-xs-3 col-sm-9" id="issuesButtons">
          <button mat-icon-button (click)="downloadCsv()"><mat-icon>download</mat-icon></button>
        </div>
      </div>
      <div class="table-wrapper">
        <mat-table [dataSource]="imageScanResultIssueData" id="issuesTable" #issueSort="matSort" matSort matSortActive="severity" matSortDisableClear matSortDirection="desc">
          <ng-container matColumnDef="scanner">
            <mat-header-cell *matHeaderCellDef mat-sort-header="scanner" disableClear> Scanner</mat-header-cell>
            <mat-cell *matCellDef="let issue" [matTooltip]="issue.scannerName"> {{issue.scannerName}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="isCompliant">
            <mat-header-cell class="ps-xs-0" *matHeaderCellDef mat-sort-header="required_for_compliance" disableClear> Compliant</mat-header-cell>
            <mat-cell *matCellDef="let issue">
              <div class="row">
                <mat-checkbox disableRipple (click)="$event.preventDefault()" [checked]="issue.isCompliant" class="pad-right-5">
                </mat-checkbox>
                <div>
                  <mat-icon *ngIf="issue.complianceReason" [matTooltip]="issue.complianceReason">info</mat-icon>
                </div>
              </div>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="severity">
            <mat-header-cell *matHeaderCellDef mat-sort-header="severity" disableClear> Severity </mat-header-cell>
            <mat-cell *matCellDef="let issue"> {{issue.severity}} </mat-cell>
          </ng-container>
          <ng-container matColumnDef="type">
            <mat-header-cell *matHeaderCellDef mat-sort-header="type" disableClear> Type </mat-header-cell>
            <mat-cell *matCellDef="let issue">
              <div class="row">
                <div class="col-xs-8">
                  <ng-container *ngIf="issue.vulnerabilityDescUrl">
                    <a [href]="issue.vulnerabilityDescUrl" target="_blank"> {{issue.type}} </a>
                  </ng-container>
                  <ng-container *ngIf="!issue.vulnerabilityDescUrl">
                    {{issue.type}}
                  </ng-container>
                </div>
                <div class="col-xs-4">
                  <button mat-icon-button (click)="searchCVE(issue.type)">
                    <mat-icon>search</mat-icon>
                  </button>
                </div>
              </div>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="packageName">
            <mat-header-cell *matHeaderCellDef mat-sort-header="package_name" disableClear> Package </mat-header-cell>
            <mat-cell *matCellDef="let issue" [matTooltip]="issue.packageName">
              {{ issue.packageName ? issue.packageName : 'N/A' }}
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef mat-sort-header="scanner_name" disableClear> Issue Title</mat-header-cell>
            <mat-cell *matCellDef="let issue" [matTooltip]="issue.name">
              {{issue.name}}
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="installedVersion">
            <mat-header-cell *matHeaderCellDef mat-sort-header="installed_version" disableClear> Installed </mat-header-cell>
            <mat-cell *matCellDef="let issue" [matTooltip]="issue.installedVersion">
              {{ issue.installedVersion ? issue.installedVersion : 'N/A' }}
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="isFixable" >
            <mat-header-cell *matHeaderCellDef mat-sort-header="is_fixable" disableClear> Fixable </mat-header-cell>
            <mat-cell *matCellDef="let issue">
              <mat-checkbox  disableRipple (click)="$event.preventDefault()"  [checked]="issue.isFixable"></mat-checkbox>
              <span *ngIf="issue.isFixable"> ({{ issue.fixedVersion ? issue.fixedVersion : 'N/A' }})</span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="more">
            <mat-header-cell matSort="false" *matHeaderCellDef disableClear></mat-header-cell>
            <mat-cell *matCellDef="let issue">
              <button mat-raised-button color="primary"
                      id="details-button"
                      (click)="showMoreIssueDetails(issue)"
              >Details</button>
              <button color="accent" id="request-exception-button" mat-raised-button *ngIf="issue.isFixable"
                      [routerLink]="['/private', 'exceptions','create']"
                      [queryParams]="{clusterId: clusterId, scannerId: issue.scannerId, cve: issue.type, policyIds: policyIds, namespaces: imageNamespaces, imageName: dataSource.url + '/' + dataSource.name  }"
              > Request Exception</button>
            </mat-cell>
          </ng-container>
<!--          <ng-container matColumnDef="request_exception">-->
<!--            <mat-header-cell *matHeaderCellDef mat-sort-header disableClear> Request Exception </th>-->
<!--            <mat-cell *matCellDef="let issue">-->
<!--              <a color="primary" mat-raised-button *ngIf="issue.isFixable"-->
<!--                 [routerLink]="['/private', 'exceptions','create']"-->
<!--                 [queryParams]="{clusterId: clusterId, scannerId: issue.scannerId, cve: issue.type, policyIds: policyIds, namespaces: imageNamespaces, imageName: dataSource.url + '/' + dataSource.name  }"-->
<!--              > Request Exception</a>-->
<!--            </mat-cell>-->
<!--          </ng-container>-->
          <mat-header-row *matHeaderRowDef="issuesDisplayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: issuesDisplayedColumns;"></mat-row>
        </mat-table>
      </div>
      <mat-paginator
        [length]="totalImageScanResultData"
        [pageSize]="imageScanResultLimit"
        [pageSizeOptions]="[10, 20, 50, 100, 200, 500, 1000]"
        (page)="pageIssues($event)"
        showFirstLastButtons #issuePaginator></mat-paginator>
    </mat-card>
  </div>
</div>

